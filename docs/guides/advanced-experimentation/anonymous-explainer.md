---
sidebar_position: 5
---

# Analyzing anonymous user experiments

In the field of A/B testing, it is common to assign unauthenticated users to experiments using anonymous identifiers such as cookies or device IDs. However, it is necessary to link these assignments to user-level events in order to calculate metrics for these unauthenticated users. In some cases, certain events may have an associated User ID, while others may not, due to users transitioning between authenticated and unauthenticated states.

For instance, consider a typical E-commerce company that maintains a table of events tracking user clicks and their progress through the purchase funnel (e.g., add-to-cart, checkout, and purchase events). Prior to making their first purchase and authenticating, any events generated by a user will not be associated with a User ID. Once the user authenticates, their events can be linked to a User ID as long as they remain logged in. However, if the user logs out, subsequent events will not be associated with a User ID until they authenticate again. This situation can result in time periods where important events are not linked to a User ID.

In a typical single-entity experimentation model, this can lead to a lot of data engineering overhead. Either every pre-authenticate (Anonymous ID) table needs to have a User ID back-populated, or every post-authentication (User ID) table needs to have an Anonymous ID forward propagated. Fortunately, Eppo can simplify this by adding entities for both the Anonymous ID and the User ID to the assignment log. 

This page walks through how to set up anonymous user experiments in Eppo using the default attribution logic. We also touch on some practical data engineering and statistical considerations. Finally, since many teams prefer to centralize attribution, we also discuss a "bring your own" approach to attribution.

## Assignment logs with multiple identifiers

Consider that you have an assignment table that looks like this:

| Anon ID | User ID | Timestamp | Experiment | Variant
| ------- | ------- | --------- | --------- | --------- | 
anon1 | NULL | 2024-07-01 00:00:00 | new-checkout | control
anon1 | 1 | 2024-07-01 10:00:00 | new-checkout |control
anon1 | 2 | 2024-07-01 12:00:00 | new-checkout |control
anon1 | NULL | 2024-07-02 12:00:00 | new-checkout | control
anon2 | NULL | 2024-07-02 00:00:00 | new-checkout |treatment
anon2 | 1 | 2024-07-02 10:00:00 | new-checkout |treatment
anon3 | NULL | 2024-07-03 00:00:00 | new-checkout |control
anon3 | 2 | 2024-07-03 10:00:00 | new-checkout |control
anon4 | NULL | 2024-07-02 10:00:00 | new-checkout | treatment

This example highlights how in general the relationship between User ID and Anonymous ID is many-to-many. That is, one Anonymous ID can be associated with multiple User IDs (a device is shared across two users) and one User ID might be associated with multiple Anonymous IDs (one user clears their cookies or has two devices).

Eppo can gracefully handle both this many-to-many relationship and assignment data with missing or duplicate records. When processing the assignment data, Eppo will perform the following clean up steps:

1. Filter to each Anonymous ID's first record during the experiment
2. Check if the Anonymous ID was associated with more than one variant. If it was, remove it from downstream analysis
3. For each Anonymous ID, determine the unique set of User IDs that was associated with it
4. Join to both Anonymous ID and User ID metrics using the appropriate join column
5. Aggregate metric events by Anonymous ID

Note that in step 3 we need to make sure each User ID is associated with only one Anonymous ID to avoid double counting post-authentication events (e.g., purchases). To ensure this, we associate each User ID with its *first* Anonymous ID during the course of the experiment.

### Assignment SQL set up in Eppo

On the assignment page ... (finish this once we have a screenshot in QA)

## Data Modeling Considerations

The approach above assumes you have relatively dense assignment data. That is, if an anonymous ID is later associated with a user, there will be a corresponding event in the assignment logs. This can be error prone. If a user is assigned on the initial landing page and then converts on a different page, it's easy to imagine the assignment log not having a record with that association. To solve this, we can simply do a one time join between the raw assignment table and another table with the full set of timestamped associations:

```sql
WITH timeboxed_associations AS (
  SELECT
        user_id
      , anonymous_id
      , lag(ts) OVER (PARTITION BY user_id ORDER BY ts) as valid_from
      , lead(ts) OVER (PARTITION BY user_id ORDER BY ts) as valid_to
  FROM user_anonymous_associations
)

SELECT 
      a.anonymous_id
    , ta.user_id
    , a.experiment
    , a.variant
    , a.timestamp
   FROM assignments a 
   LEFT JOIN timeboxed_associations ta
     ON a.anonymous_id = ta.anonymous_id
    AND ta.valid_from <= a.timestamp
    AND ta.valid_to > a.timestamp
     
```

By adding this to your assignment data model you can be sure to capture every association between anonymous IDs and users.


## Statistical Considerations

The approach outlined above treats each anonymous ID as a unique subject in the experiment. The astute reader may be concerned about this violating assumptions around independent and identically distributed (i.i.d.) metrics. Specifically, we expect the relationship between two Anonymous IDs associated with the same User ID to be correlated. It might be tempting to instead aggregate by User ID. This would however present two new issues. First, users may experience both variants. It's straightforward to filter these user's out in the Eppo analysis, but this preferentially removes more active users (a users with three associated Anonymous IDs is more engaged than a user with one) and can lead to biased experiment results.

Second, it's undeniable that most users who have multiple anonymous IDs will never log in on every device. That is, there will inevitably be some Anonymous IDs that are indeed correlated but their relationship is never observed in event logs.

Finally, experiments at the Anonymous ID level tend to have a shorter impact horizon than those on User ID. A new copy test for instance is most likely to impact in-session conversion. Given this, it's safe to expect relatively small interference between mutliple sessions from the same user.

Ultimately the decision to treat Anonymous IDs as the subject in experiments comes with a tradeoff. It may in some cases slightly violate the i.i.d. assumption, but it does avoid complications that arise from the alternative user-based approach. That said, there are reasons you might want to instead do attribute a different way. One very practical reason is that other teams may already rely on a specific attribution model. Fortunately, since Eppo is warehouse native it's easy to continue to use your existing attribution logic. To learn more, continue on to the next section.


## Using your own existing attribution

Since Eppo uses the data in your warehouse it's very easy to leverage existing attribution models that connect Anonymous IDs and User IDs. Many companies built their own attribute logic to combine both IDs into a single "combined ID". This ID can then be added to both pre-authentication (Anonymous ID) tables and post-authentication (User ID) tables. By creating a single "Combined ID" [entity](/data-management/definitions/entities), you can then tell Eppo to simply use this column to join assignments to facts.

This gives you two options: either continue to use your existing attribution and point Eppo at tables with resolved IDs, or point Eppo at your raw data and have Eppo handle the attribution.
