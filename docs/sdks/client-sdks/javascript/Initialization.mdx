---
title: Initialization
sidebar_position: 3
---

The Eppo JavaScript SDK is simple to initialize but provides a number of options for customization that makes it flexible for a wide range of use cases including offline mode, custom caching requirements, and extremely low latency initialization.

## Initialize the SDK

To complete basic initialization, you only need to provide your SDK key which you can find in the Eppo UI under **Admin** > **API Keys**. 

```js
const eppo = new Eppo({
  apiKey: 'YOUR_API_KEY',
});
``` 

## Use the SDK instance
After initialization, you can use the SDK instance by importing the SDK at the scope you will use it in and calling `getInstance()`. You can then use the SDK instance to assign a variation to a subject using the `get*Assignment` functions.

```javascript
import * as EppoSdk from "@eppo/js-client-sdk";

const eppoClient = EppoSdk.getInstance();
const user = getCurrentUser();

```


## Advanced Configuration
Basic initialization is great for most use cases, but the SDK provides options that you can use during initialization to customize the behavior of the SDK.

### Initialization Options

How the SDK fetches, serves, and caches experiment configurations is configurable via additional optional initialization options:

| Option                                            | Description                                                                                                                                                                                                                                                                                                                            | Default         |
|---------------------------------------------------|----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|-----------------| 
| **`requestTimeoutMs`** (number)                   | Timeout in milliseconds for HTTPS requests for the experiment configurations.                                                                                                                                                                                                                                                          | `5000`          |
| **`numInitialRequestRetries`** (number)           | Number of _additional_ times the initial configurations request will be attempted if it fails. This is the request typically synchronously waited (via `await`) for completion. A small wait will be done between requests.                                                                                                            | `1`             |
| **`pollAfterSuccessfulInitialization`** (boolean) | Poll for new configurations (every 30 seconds) after successfully requesting the initial configurations.                                                                                                                                                                                                                               | `false`         |
| **`pollAfterFailedInitialization`** (boolean)     | Poll for new configurations even if the initial configurations request failed.                                                                                                                                                                                                                                                         | `false`         |
| **`throwOnFailedInitialization`** (boolean)       | Throw an error (reject the promise) if unable to fetch initial configurations during initialization.                                                                                                                                                                                                                                   | `true`          |
| **`numPollRequestRetries`** (number)              | If polling for updated configurations after initialization, the number of additional times a request will be attempted before giving up. Subsequent attempts are done using an exponential backoff.                                                                                                                                    | `7`             |
| **`skipInitialRequest`** (boolean)                | Skip the initial request for a new configuration during initialization (if polling is enabled, this will still take place later)                                                                                                                                                                                                       | `false`         |
| **`persistentStore`** (IAsyncStore)               | An asynchronous, persistent storage for caching fetched flag configurations for use in subsequent sessions                                                                                                                                                                                                                             | _Eppo provided_ |
| **`maxCacheAgeSeconds`** (number)                 | Maximum age, in seconds, that a previously cached configuration is considered valid and the wait-time before fetching a fresh configuration                                                                                                                                                                                            | `0`             |
| **`useExpiredCache`** (boolean)                   | Consider initialization successfully complete without fetching updates, even if the configuration loaded from the cache is expired                                                                                                                                                                                                     | `false`         |
| **`updateOnFetch`** (always\|expired\|empty)      | Sets how the configuration is updated after a successful fetch:<br/>• always - immediately start using the new configuration<br/>• expired - immediately start using the new configuration only if the current one has expired<br/>• empty - only use the new configuration if the current one is both expired and uninitialized/empty | `'always'`      |

### Configuration caching
The SDK can cache previously loaded configurations for use in future sessions. 
This makes the SDK initialize faster.

By default, a Local Storage-based cache is used in a browser environment and a Chrome Storage-based cache is used in a Chrome extension environment.
A custom cache can be provided as the `persistentStore` initialization option.

#### Why cache configurations?
Caching experiment configurations locally improves your application by making it faster and giving it a fallback value when network requests fail.

#### How configuration Caching Works
The SDK automatically caches configurations using:
- Local Storage in browser environments
- Chrome Storage in extension environments

You can also implement your own custom cache by providing a `persistentStore`:

```javascript
const eppo = new Eppo({
  apiKey: 'YOUR_API_KEY',
  persistentStore: myCustomStore
});
```
#### Expiration
Caching settings depend on the concept of expiration. Expiration is controlled by the `maxCacheAgeSeconds` initialization option. This setting is overridable by the implementation of `isExpired()` for a custom persistent store.

When the cached configuration is not expired, it is considered valid and no fetches will be made for updated configurations.


#### Example configuration options
There are a few common configurations that you might want to use depending on what type of performance and consistency characteristics you want for your application.

##### Prioritize flag value freshness
If you want to always using the latest flag values, you'd want settings that:
- Consider anything cached expired
- Do not use expired cached configurations
- Immediately start using the new configuration after it is fetched
- Do not retry a failed initialization fetch

Use the following configuration to achieve this:

```ts
const eppo = new Eppo({
  apiKey: 'YOUR_API_KEY',
  maxCacheAgeSeconds: 0, // Always consider cached configurations expired
  useExpiredCache: false, // Wait for an updated configuration to be fetched before initialization is considered successful
  updateOnFetch: 'always', // Immediately start using the new configuration after it is fetched
  requestTimeoutMs: 5000, // Don't time out the initial configuration request until five seconds have passed
  numInitialRequestRetries: 1, // If the initial configuration request fails, try one more time 
  pollAfterSuccessfulInitialization: true, // Check for updated configurations every 30 seconds
  pollAfterFailedInitialization: false, // Check for updated configurations even if initialization wasn't able to load one
});
```
This configuration ensures the SDK will use the lastest assignment values immediately but may be slower to initialize than other approaches.

###### Prioritize fast initialization
If you want to optimize for the quickest time to initialization and serving assignments--even if those assignments may be out of date, you would want settings that:
- Immediately start using the new configuration after it is fetched
- Allow initializing with older configurations
- Reduce the initial fetch timeout and retries to quickly fall back to default values

Use the following configuration to achieve those goals:

```ts
const eppo = new Eppo({
  apiKey: 'YOUR_API_KEY',
  updateOnFetch: 'always', // Immediately start using the new configuration once it is fetched
  maxCacheAgeSeconds: 300, // Don't even bother fetching updated configurations unless the last one is more than five minutes old
  useExpiredCache: true, // If the cached configuration is expired, use it to serve assignments until an updated one is fetched
  requestTimeoutMs: 500, // Give up on fetching updated configurations after half a second and--if this is the first-ever initialization--just serve default values
  numInitialRequestRetries: 0, // Don't retry a failed initialization fetch
});
```

Note that when new configurations are loaded, the same flag may start getting a different assignment for the same session. If you want to avoid this, and have consistent assignments until the next initialization, change `updateOnFetch` to `empty`.
You could consider caches always expired so that it non-blocking loads an updated configuration to be used in the next session.

```ts
const eppo = new Eppo({
  apiKey: 'YOUR_API_KEY',
  maxCacheAgeSeconds: 0, // Always consider cached configurations expired
  // Settings set to non-default values
  updateOnFetch: 'empty', // Immediately start using the new configuration once it is fetched
  useExpiredCache: true, // Always used the previously cached assignments
  requestTimeoutMs: 500, // Give up on fetching updated configurations after half a second and--if this is the first-ever initialization--just serve default values
  numInitialRequestRetries: 0, // Don't retry a failed initialization fetch
});
```

### Offline initialization

Eppo's SDK supports offline initialization if you want to initialize the SDK with a configuration from your server SDK or other external process. In this mode the SDK will not attempt to fetch a configuration from Eppo's CDN, instead only using the provided values.

This function is synchronous and ready to handle assignments after it returns.

```javascript
import { offlineInit, Flag, ObfuscatedFlag } from "@eppo/js-client-sdk";

// configuration from your server SDK
const configurationJsonString: string = getConfigurationFromServer();

// The configuration will be not-obfuscated from your server SDK.
// If you have obfuscated flag values, you can use the `ObfuscatedFlag` type.
const flagsConfiguration: Record<string, Flag | ObfuscatedFlag> = JSON.parse(configurationJsonString);

offlineInit({ 
  flagsConfiguration,
  // If you have obfuscated flag values, you can use the `ObfuscatedFlag` type.
  isObfuscated: true,
 });
```

The `offlineInit` function accepts the following optional configuration arguments.

| Option | Type | Description | Default |
| ------ | ----- | ----- | ----- | 
| **`assignmentLogger`**  | [IAssignmentLogger](https://github.com/Eppo-exp/js-client-sdk-common/blob/75c2ea1d91101d579138d07d46fca4c6ea4aafaf/src/assignment-logger.ts#L55-L62) | A callback that sends each assignment to your data warehouse. Required only for experiment analysis. See [example](#assignment-logger) below. | `null` |
| **`flagsConfiguration`** | Record<string, Flag \| ObfuscatedFlag> | The flags configuration to use for the SDK. | `null` |
| **`isObfuscated`** | boolean | Whether the flag values are obfuscated. | `false` |
| **`throwOnFailedInitialization`** | boolean | Throw an error if an error occurs during initialization. | `true` |

## Assignment Logger Schema

The SDK will invoke the `logAssignment` function with an `assignment` object that contains the following fields:

| Field                              | Description                                                                                                              | Example                                                                          |
|------------------------------------|--------------------------------------------------------------------------------------------------------------------------|----------------------------------------------------------------------------------|
| `timestamp` (string)               | The time when the subject was assigned to the variation                                                                  | 2021-06-22T17:35:12.000Z                                                         |
| `featureFlag` (string)             | An Eppo feature flag key                                                                                                 | "recommendation-algo"                                                            |
| `allocation` (string)              | An Eppo allocation key                                                                                                   | "allocation-17"                                                                  |
| `experiment` (string)              | An Eppo experiment key                                                                                                   | "recommendation-algo-allocation-17"                                              |
| `subject` (string)                 | An identifier of the subject or user assigned to the experiment variation                                                | UUID                                                                             |
| `subjectAttributes` (map)          | A free-form map of metadata about the subject. These attributes are only logged if passed to the SDK assignment function | `{ "country": "US" }`                                                            |
| `variation` (string)               | The experiment variation the subject was assigned to                                                                     | "control"                                                                        |
| `metaData` (Record<string,string>) | Metadata around the assignment, such as the version of the SDK                                                           | `{ "obfuscated: "true", "sdkLanguage": "javascript", "sdkLibVersion": "3.2.1" }` |

More details about logging and examples (with Segment, Rudderstack, mParticle, and Snowplow) can be found in the [event logging](/sdks/event-logging/) page.

## Appendix

### Usage in React

For usage in React, we recommend using the below `EppoRandomizationProvider` at the root of your component tree. By default, this component waits for initialization of the SDK before rendering its children. If `waitForInitialization` is set to false, the SDK `getStringAssignment` function will return `null` assignments while initializing and will only start assigning subjects when a new browser session is started.

```tsx
import { useEffect, useState } from "react";

import { init } from "@eppo/js-client-sdk";

interface IEppoRandomizationProvider {
  waitForInitialization?: boolean;
  children: JSX.Element;
  loadingComponent?: JSX.Element;
}

export default function EppoRandomizationProvider({
  waitForInitialization = true,
  children,
  loadingComponent = <div>Loading...</div>,
}: IEppoRandomizationProvider): JSX.Element {
  const [isInitialized, setIsInitialized] = useState(false);
  useEffect(() => {
    init({
      apiKey: "<YOUR-SDK-KEY>",
      assignmentLogger: {
        logAssignment(assignment) {
          // logging implementation
        },
      },
    }).then(() => {
      return setIsInitialized(true);
    });
  }, []);

  if (!waitForInitialization || isInitialized) {
    return children;
  }
  return loadingComponent;
}
```

After the SDK is initialized, you may assign variations from any child component of `EppoRandomizationProvider`. We recommend wrapping the SDK code in a [useMemo hook](https://reactjs.org/docs/hooks-reference.html#usememo) to avoid invoking the assignment logic on every render:

```tsx
<EppoRandomizationProvider>
  <MyComponent />
</EppoRandomizationProvider>
```

```tsx
function MyComponent(): JSX.Element {
  const assignedVariation = useMemo(() => {
    const eppoClient = getInstance();
    return eppoClient.getStringAssignment("<FLAG-KEY>", "<SUBJECT-KEY>", <SUBJECT-ATTRIBUTES>, "<DEFAULT-VALUE>");
  }, []);

  return (
    <div>
      {assignedVariation === "<VARIATION-KEY>" && <p>Assigned control</p>}
    </div>
  );
}
```

### Browser Support

The SDK is supported on all modern browsers. It relies on JavaScript promises, which may not be supported on older browsers including IE. If you need to run the SDK on a browser that does not support promises, it is possible to use a [polyfill library](https://www.npmjs.com/package/promise-polyfill).

### Local Storage

The SDK uses browser local storage to store experiment configurations downloaded from Eppo. This allows for quick lookup by the `getStringAssignment` function. The configuration data stored contains the experiment key, experiment variation values, traffic allocation, and any allow-list overrides.

### Debugging

You may encounter a situation where a flag assignment produces a value that you did not expect. There are functions [detailed here](/sdks/sdk-features/debugging-flag-assignment) to help you understand how flags are assigned, which will allow you to take corrective action on potential configuration issues. 
